import{a as Y}from"./chunk-64VNNNML.js";import{defineComponent as Me,Type as Ne}from"@latticexyz/recs";function ke(t){return Me(t,{value:Ne.OptionalNumber},{id:"DevHighlight"})}import{defineComponent as We,Type as Oe}from"@latticexyz/recs";function Re(t,e){return We(t,{value:Oe.Number},e)}import{defineComponent as He,Type as De}from"@latticexyz/recs";function Ve(t,e){return He(t,{value:De.Boolean},e)}import{defineComponent as Be,Type as X}from"@latticexyz/recs";function Ue(t,e){return Be(t,{x:X.Number,y:X.Number},e)}import{defineComponent as Pe,Type as $e}from"@latticexyz/recs";function H(t,e){return Pe(t,{value:$e.String},e)}import{defineComponent as Fe,Type as W}from"@latticexyz/recs";function P(t){return Fe(t,{state:W.Number,on:W.OptionalEntity,metadata:W.OptionalT,overrides:W.OptionalStringArray,txHash:W.OptionalString},{id:"Action"})}import{defineComponent as Le,Type as $}from"@latticexyz/recs";function je(t,e){return Le(t,{x:$.Number,y:$.Number,z:$.Number},e)}import{getComponentValue as Ke,getComponentValueStrict as L,Has as Qe,hasComponent as M,HasValue as qe,runQuery as Ge,componentValueEquals as ze}from"@latticexyz/recs";import{keccak256 as Je}from"@latticexyz/utils";import{BigNumber as F}from"ethers";import{SingletonID as _e}from"@latticexyz/network";import{deferred as Ye}from"@latticexyz/utils";import{filter as Xe}from"rxjs";function Jn(t,e){return Ze(t,e.currentTime/1e3)}function Ze(t,e){let o=et(t);if(!o)return-1;let r=F.from(o.startTime),a=F.from(o.turnLength);return F.from(Math.floor(e)).sub(r).div(a).toNumber()}function et(t){return Ke(t,_e)}function _n(t,e,o){return Ge([qe(e,o),Qe(t)]).size>0}function Yn(t,e){if(!t)return;let o=t;if(!(o==null||!M(e,o)))return o}function Xn(t,e){for(;M(t,e);){let o=L(t,e).value;if(!o)return;e=o}return e}function Zn(t,e,o){if(M(o,e))return e;for(;M(t,e);){let r=L(t,e).value;if(r==null)return;if(e=r,M(o,e))return e}}function eo(t,e,o){if(e===o)return!0;for(;M(t,e);){let r=L(t,e).value;if(r==null)return!1;if(e=r,e===o)return!0}return!1}function tt(t){let e=new Array(4);function o(m){for(let s=0;s<e.length;s++)e[s]=0;for(let s=0;s<m.length;s++)e[s%4]=(e[s%4]<<5)-e[s%4]+m.charCodeAt(s)}function r(){let m=e[0]^e[0]<<11;return e[0]=e[1],e[1]=e[2],e[2]=e[3],e[3]=e[3]^e[3]>>19^m^m>>8,(e[3]>>>0)/(1<<31>>>0)}function a(){let m=Math.floor(r()*360)/360,s=80/100,c=70/100;return[m,s,c]}function l(m,s,c){return m<<16|s<<8|c}function d(m,s,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?m+(s-m)*6*c:c<1/2?s:c<2/3?m+(s-m)*(2/3-c)*6:m}function i(m,s,c){let C,S,n;if(s===0)C=S=n=c;else{let p=c<.5?c*(1+s):c+s-c*s,y=2*c-p;C=d(y,p,m+1/3),S=d(y,p,m),n=d(y,p,m-1/3)}return[C*255,S*255,n*255]}return o(t),l(...i(...a()))}function to(t){return tt(Je(t).substring(2))}function j(t,e,o){let[r,,a]=Ye(),l=r,d=t.update$.pipe(Xe(i=>i.entity===e&&!!o.find(m=>ze(m,i.value[0])))).subscribe(()=>{r(),l()});return l=()=>d?.unsubscribe(),a}async function no(t,e,o){await j(t,e,[o])}import{defineQuery as nt,toUpdate as ot}from"@latticexyz/recs";import{useEffect as Z,useMemo as rt,useState as ee}from"react";import{filter as at}from"rxjs";function it(t,e){let[o,r]=ee(e);return Z(()=>{let a=t.subscribe(l=>r(l));return()=>a?.unsubscribe()},[]),o}function lo(t,e){let o=rt(()=>e!=null?t.update$.pipe(at(a=>a.entity===e)):t.update$.asObservable(),[t,e]),r=it(o,e!=null?ot(e,t):void 0);return r?r.value[0]:null}function fo(t){let[e,o]=ee();return Z(()=>{let r=nt(t,{runOnInit:!0}),a=r.update$.subscribe();return o(r.matching),()=>a?.unsubscribe()},[]),e}import{createEntity as mt,getComponentValue as V,overridableComponent as te,updateComponent as w,setComponent as ct}from"@latticexyz/recs";import{mapObject as dt,awaitStreamValue as pt,uuid as ut}from"@latticexyz/utils";var D=(i=>(i[i.Requested=0]="Requested",i[i.Executing=1]="Executing",i[i.WaitingForTxEvents=2]="WaitingForTxEvents",i[i.Complete=3]="Complete",i[i.Failed=4]="Failed",i[i.Cancelled=5]="Cancelled",i[i.TxReduced=6]="TxReduced",i))(D||{}),st={[6]:"TxReduced",[0]:"Requested",[1]:"Executing",[2]:"WaitingForTxEvents",[3]:"Complete",[4]:"Failed",[5]:"Cancelled"};import{merge as lt}from"rxjs";function ft(t,e){let o=P(t),r={},a=new Map,l=new Map;t.registerDisposer(()=>{for(let{dispose:n}of l.values())n()});function d(n){let p=r[n.id]||te(n);return r[n.id]||(r[n.id]=p),p}function i(n){if(t.hasEntity(n.id))return console.warn(`Action with id ${n.id} is already requested.`),n.id;let y=mt(t,void 0,{id:n.id});ct(o,y,{state:0,on:n.on,metadata:n.metadata,overrides:void 0,txHash:void 0});for(let[f,E]of Object.entries(n.components))r[f]||(r[f]=te(E));let u={...n,entity:y,componentsWithOptimisticUpdates:dt(n.components,f=>d(f))};a.set(u.id,u);let g=lt(...Object.values(u.componentsWithOptimisticUpdates).map(f=>f.update$)).subscribe(()=>m(u));return m(u),l.set(u.id,{dispose:()=>g?.unsubscribe()}),y}function m(n){if(V(o,n.entity)?.state!==0)return;let p=n.requirement(n.componentsWithOptimisticUpdates);p&&s(n,p)}async function s(n,p){if(V(o,n.entity)?.state!==0)return;w(o,n.entity,{state:1});let y=n.updates(n.componentsWithOptimisticUpdates,p).map(u=>({...u,id:ut()}));w(o,n.entity,{overrides:y.map(u=>`${u.id}/${u.component}`)});for(let{component:u,value:g,entity:f,id:E}of y)r[u].addOverride(E,{entity:f,value:g});try{let u=await n.execute(p);if(u){w(o,n.entity,{state:2,txHash:u.hash});let g=u.wait().catch(f=>c(f,n));n.txMayNotWriteToTable||await pt(e,f=>f===u.hash),w(o,n.entity,{state:6}),(n.awaitConfirmation||n.txMayNotWriteToTable)&&await g}w(o,n.entity,{state:3})}catch(u){c(u,n)}S(n.id)}function c(n,p){console.error(n),w(o,p.entity,{state:4}),S(p.id)}function C(n){let p=a.get(n);return!p||V(o,p.entity)?.state!==0?(console.warn(`Action ${n} was not found or is not in the "Requested" state.`),!1):(w(o,p.entity,{state:5}),S(n),!0)}function S(n){if(!a.get(n)){console.warn(`Trying to remove action ${n} that does not exist.`);return}let y=n,u=y!=null&&V(o,y)?.overrides||[];for(let g of u){let[f,E]=g.split("/");r[E].removeOverride(f)}l.get(n)?.dispose(),l.delete(n),a.delete(n),y!=null&&setTimeout(()=>t.deleteEntity(y),5e3)}return{add:i,cancel:C,withOptimisticUpdates:d,Action:o}}async function ne(t,e){return j(t,e,[{state:5},{state:4},{state:3}])}import{createNetwork as Ot,createContracts as Rt,createTxQueue as Ht,createSyncWorker as Dt,InputType as Vt,SingletonID as ce,keyTupleToEntityID as Bt}from"@latticexyz/network";import{BehaviorSubject as Ut,concatMap as Pt,from as $t,Subject as Ft}from"rxjs";import{defineComponent as de,Type as O}from"@latticexyz/recs";import{computed as Lt}from"mobx";import{keccak256 as jt}from"@latticexyz/utils";import{TableId as Kt}from"@latticexyz/common";import{IWorldKernel__factory as pe}from"@latticexyz/world/types/ethers-contracts/factories/IWorldKernel.sol/IWorldKernel__factory";import{ack as oe,createEncoder as yt,isNetworkComponentUpdateEvent as bt,isSystemCallEvent as gt}from"@latticexyz/network";import{getComponentValue as Ct,removeComponent as St,setComponent as xt,getComponentEntities as vt,getComponentValueStrict as Tt,updateComponent as ht}from"@latticexyz/recs";import{isDefined as It}from"@latticexyz/common/utils";import{toEthAddress as Et}from"@latticexyz/utils";import wt from"@latticexyz/solecs/abi/Component.sol/Component.json";import{Contract as At,BigNumber as Mt}from"ethers";import{filter as Nt,map as kt,Subject as K,timer as Wt}from"rxjs";function mr(t,e,o){return r=>{let a=r.entity??t.registerEntity({id:r.entity}),l=o[r.component],d=e[l];if(!l){console.error(`Component mapping not found for component ID ${r.component} ${JSON.stringify(r.value)}`);return}return{...r,entity:a,component:d}}}function cr(t,e,o,r,a){let l=e.reduce((d,i)=>({...d,[i]:new K}),{});return{systemCallStreams:l,decodeAndEmitSystemCall:d=>{let{tx:i}=d,m=Mt.from(i.to).toHexString().toLowerCase();if(!m)return;let s=Ct(o,m)?.value;if(!s)return;let{name:c,contract:C}=r(s),S=C.interface.parseTransaction({data:i.data,value:i.value});l[c]||(l[c]=new K),l[c].next({...d,updates:d.updates.map(a).filter(It),systemId:c,args:S.args})}}}async function ae(t,e,o){let r={};async function a(d){let i=Et(d),m=Tt(e,d).value;console.info("[SyncUtils] Creating encoder for "+i);let s=new At(i,wt.abi,o.get()),[c,C]=await s.getSchema();r[m]=yt(c,C)}for(let d of vt(e))a(d);let l=e.update$.subscribe(d=>a(d.entity));return t.registerDisposer(()=>l?.unsubscribe()),r}function ie(t,e,o,r,a,l,d,i){let m=new K,s=!1,c=Wt(0,100).pipe(Nt(()=>!s),kt(()=>oe)).subscribe(a),C=o.subscribe(S=>{s=!0;for(let n of S)if(bt(n)){if(n.lastEventInTx&&m.next(n.txHash),d&&l){let{namespace:g,table:f,key:E}=n,x=l.tables[f];if(!(!x||g!==l.namespace)){let A=re(E,Object.getOwnPropertyNames(x.keySchema)),R=n.value??n.partialValue;if(R){let B=re(R,Object.getOwnPropertyNames(x.schema));d.set(g,f,A,B)}else d.remove(g,f,A)}}let p=n.entity??t.registerEntity({id:n.entity}),y=r[n.component];if(!y){console.warn("Unknown component:",n);continue}let u=e[y];n.partialValue!==void 0?ht(u,p,n.partialValue,n.initialValue):n.value===void 0?St(u,p):xt(u,p,n.value)}else i&&gt(n)&&i(n);a.next(oe),s=!1});return t.registerDisposer(()=>{C?.unsubscribe(),c?.unsubscribe()}),{txReduced$:m.asObservable()}}function re(t,e){let o={};return e.forEach((r,a)=>{a in t&&(o[r]=t[a])}),o}import{TableId as N}from"@latticexyz/common";import{defineComponent as k,Type as T}from"@latticexyz/recs";function se(t){return{Hooks:(()=>{let e=new N("mudstore","Hooks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),Callbacks:(()=>{let e=new N("mudstore","Callbacks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),StoreMetadata:(()=>{let e=new N("mudstore","StoreMetadata");return k(t,{tableName:T.String,abiEncodedFieldNames:T.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),Mixed:(()=>{let e=new N("mudstore","Mixed");return k(t,{u32:T.Number,u128:T.BigInt,a32:T.NumberArray,s:T.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),Vector2:(()=>{let e=new N("mudstore","Vector2");return k(t,{x:T.Number,y:T.Number},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),KeyEncoding:(()=>{let e=new N("mudstore","KeyEncoding");return k(t,{value:T.Boolean},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})()}}import{TableId as h}from"@latticexyz/common";import{defineComponent as I,Type as b}from"@latticexyz/recs";function me(t){return{NamespaceOwner:(()=>{let e=new h("","NamespaceOwner");return I(t,{owner:b.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),ResourceAccess:(()=>{let e=new h("","ResourceAccess");return I(t,{access:b.Boolean},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),InstalledModules:(()=>{let e=new h("","InstalledModules");return I(t,{moduleAddress:b.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),Callers:(()=>{let e=new h("","Callers");return I(t,{callerList:b.StringArray},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),Systems:(()=>{let e=new h("","Systems");return I(t,{system:b.String,publicAccess:b.Boolean},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),SystemRegistry:(()=>{let e=new h("","SystemRegistry");return I(t,{resourceSelector:b.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),SystemHooks:(()=>{let e=new h("","SystemHooks");return I(t,{value:b.StringArray},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),ResourceType:(()=>{let e=new h("","ResourceType");return I(t,{resourceType:b.Number},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),FunctionSelectors:(()=>{let e=new h("","FunctionSelector");return I(t,{staticCallOnly:b.Boolean,namespace:b.String,name:b.String,systemFunctionSelector:b.String},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),KeysInTable:(()=>{let e=new h("","KeysInTable");return I(t,{keys0:b.StringArray,keys1:b.StringArray,keys2:b.StringArray,keys3:b.StringArray,keys4:b.StringArray},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})(),UsedKeysIndex:(()=>{let e=new h("","UsedKeysIndex");return I(t,{has:b.Boolean,index:b.Number},{metadata:{contractId:e.toHex(),tableId:e.toString()}})})()}}import{createDatabase as Qt,createDatabaseClient as qt}from"@latticexyz/store-cache";async function Br({networkConfig:t,world:e,contractComponents:o,initialGasPrice:r,fetchSystemCalls:a,syncThread:l,storeConfig:d,syncStoreCache:i=!0,worldAbi:m=pe.abi,useABIInDevTools:s=!0}){s&&Y.next(m);let c=H(e,{id:"SystemsRegistry",metadata:{contractId:"world.component.systems"}}),C=H(e,{id:"ComponentsRegistry",metadata:{contractId:"world.component.components"}}),S=de(e,{state:O.Number,msg:O.String,percentage:O.Number},{id:"LoadingState",metadata:{contractId:"component.LoadingState"}}),n=new Kt("mudstore","schema"),p=de(e,{valueSchema:O.String,keySchema:O.String},{metadata:{contractId:n.toHex(),tableId:n.toString()}}),y=se(e),u=me(e),g={storeSchemaComponent:p,...y,...u,...o,SystemsRegistry:c,ComponentsRegistry:C,LoadingState:S},f={};function E(v,U){let{contractId:Ae,tableId:_}=U.metadata;_?f[_]=v:f[jt(Ae)]=v}for(let v of Object.keys(g))E(v,g[v]);let x=await Ot(t);e.registerDisposer(x.dispose);let A=Lt(()=>x.signer.get()||x.providers.get().json),{contracts:R,config:B}=await Rt({config:{World:{abi:pe.abi,address:t.worldAddress}},signerOrProvider:A}),Q=new Ut(r||Math.ceil((await A.get().getGasPrice()).toNumber()*1.3)),{txQueue:ye,dispose:be}=Ht(R,x,Q,{devMode:t.devMode});e.registerDisposer(be);let ge=e.registerEntity({id:ce}),q=x.connectedAddress.get(),Ce=q?e.registerEntity({id:Bt([q])}):void 0,G=new Ft,{provider:{externalProvider:_t,...Se},...xe}=t,{ecsEvents$:z,input$:ve,dispose:Te}=Dt(G,{thread:l});e.registerDisposer(Te);function he(v,U){ve.next({type:Vt.Config,data:{...xe,provider:Se,worldContract:B.World,initialBlockNumber:U??t.initialBlockNumber,disableCache:t.disableCache||[31337,1337].includes(t.chainId),fetchSystemCalls:a,initialRecords:v}})}let Ie=Qt(),J=qt(Ie,d),{txReduced$:Ee}=ie(e,g,z,f,G,i?d:void 0,i?J:void 0),we=t.encoders?ae(e,C,A):new Promise(v=>v({}));return{txQueue:ye,txReduced$:Ee,encoders:we,network:x,startSync:he,gasPriceInput$:Q,ecsEvent$:z.pipe(Pt(v=>$t(v))),mappings:f,registerComponent:E,networkConfig:t,world:e,components:g,singletonEntityId:ce,singletonEntity:ge,playerEntity:Ce,storeCache:J}}import{generatePrivateKey as Gt,privateKeyToAccount as fe}from"viem/accounts";import{isHex as zt}from"viem";import{BehaviorSubject as ue}from"rxjs";function le(t,e){if(!zt(t))throw console.error("Private key found in cache is not valid hex",{privateKey:t,cacheKey:e}),new Error(`Private key found in cache (${e}) is not valid hex`);fe(t)}function Jt(t="mud:burnerWallet"){let e=localStorage.getItem(t);e!=null&&le(e,t);let o=e!=null?new ue(e):(()=>{let r=Gt();return console.log("New burner wallet created:",fe(r)),localStorage.setItem(t,r),new ue(r)})();return window.addEventListener("storage",function r(a){if(o.closed){window.removeEventListener("storage",r);return}if(a.key===t&&a.storageArea===localStorage){if(!a.newValue){console.warn("Burner wallet removed from cache! You may need to reload to create a new wallet.");return}le(a.newValue,t),o.next(a.newValue)}}),o}export{D as ActionState,st as ActionStateString,ie as applyNetworkUpdates,ft as createActionSystem,mr as createDecodeNetworkComponentUpdate,ae as createEncoders,cr as createSystemCallStreams,P as defineActionComponent,Ve as defineBoolComponent,Ue as defineCoordComponent,ke as defineDevHighlightComponent,Re as defineNumberComponent,H as defineStringComponent,je as defineVoxelCoordComponent,Zn as findEntityWithComponentInRelationshipChain,eo as findInRelationshipChain,Jt as getBurnerWallet,Jn as getCurrentTurn,et as getGameConfig,Yn as getPlayerEntity,to as getStringColor,Ze as getTurnAtTime,_n as isUntraversable,tt as randomColor,Xn as resolveRelationshipChain,Br as setupMUDV2Network,lo as useComponentValueStream,fo as useQuery,it as useStream,ne as waitForActionCompletion,no as waitForComponentValue,j as waitForComponentValueIn};
//# sourceMappingURL=index.js.map