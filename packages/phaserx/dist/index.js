"use strict";var ee=Object.defineProperty;var He=Object.getOwnPropertyDescriptor;var Be=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Xe=(t,e,o)=>e in t?ee(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var Ze=(t,e)=>{for(var o in e)ee(t,o,{get:e[o],enumerable:!0})},Ue=(t,e,o,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Be(e))!Ye.call(t,r)&&r!==o&&ee(t,r,{get:()=>e[r],enumerable:!(i=He(e,r))||i.enumerable});return t};var Je=t=>Ue(ee({},"__esModule",{value:!0}),t);var te=(t,e,o)=>(Xe(t,typeof e!="symbol"?e+"":e,o),o);var ut={};Ze(ut,{AssetType:()=>be,GameObjectClasses:()=>ae,HueTintAndOutlineFXPipeline:()=>D,MultiHueTintPipeline:()=>E,ZERO_VECTOR:()=>Se,addCoords:()=>Oe,chunkCoordToTileCoord:()=>re,chunkToPixelCoord:()=>_,coordEq:()=>oe,cornerTileCoordsFromRegionCoords:()=>Ae,createAnimatedTilemap:()=>de,createCamera:()=>he,createChunkedTilemap:()=>ue,createChunks:()=>ce,createCulling:()=>xe,createDebugger:()=>lt,createInput:()=>ke,createObjectPool:()=>Te,createPhaserEngine:()=>at,createVirtualTilemap:()=>me,defineAssetsConfig:()=>tt,defineCameraConfig:()=>it,defineMapConfig:()=>ot,definePhaserConfig:()=>Ce,defineScaleConfig:()=>nt,defineScene:()=>ye,defineSceneConfig:()=>rt,generateFrames:()=>se,getChunksInArea:()=>ie,getObjectsInArea:()=>Le,isRectangle:()=>ge,isSprite:()=>le,isTileInArea:()=>Ke,load:()=>ne,mod:()=>I,pixelCoordToTileCoord:()=>fe,pixelToChunkCoord:()=>F,removeAllTweens:()=>B,tileCoordToChunkCoord:()=>V,tileCoordToPixelCoord:()=>Y,tween:()=>Pe});module.exports=Je(ut);var jo=require("phaser");var we=require("@latticexyz/utils");async function Pe(t,e){let[o,,i]=(0,we.deferred)(),{targets:r}=t;if(!(!r.scene||!r.scene.tweens))return e?.keepExistingTweens||B(r),r.scene.tweens.add({...t,onComplete:(s,c)=>{t.onComplete&&t.onComplete(s,c),o()}}),i}function B(t){let e=t.scene.tweens;for(let o of e.tweens)o.hasTarget(t)&&o.stop()}function I(t,e){return(t%e+e)%e}var Se={x:0,y:0};function Ae(t,e){let o=[];return t.forEach(i=>{let r={x:i.x*e,y:i.y*e},s={x:(i.x+1)*e-1,y:i.y*e},c={x:i.x*e,y:(i.y+1)*e-1},n={x:(i.x+1)*e-1,y:(i.y+1)*e-1};o.push(r,s,c,n)}),o}function Ke(t,e){return t.x>=e.x&&t.x<e.x+e.width&&t.y>=e.x&&t.y<e.y+e.height}function oe(t,e){return!t&&!e?!0:!t||!e?!1:t.x===e.x&&t.y===e.y}function Oe(t,e){return{x:t.x+e.x,y:t.y+e.y}}function F(t,e){return{x:Math.floor(t.x/e),y:Math.floor(t.y/e)}}function _(t,e){return{x:t.x*e,y:t.y*e}}function fe(t,e,o){return{x:Math.floor(t.x/e),y:Math.floor(t.y/o)}}function Y(t,e,o){return{x:t.x*e,y:t.y*o}}function V(t,e,o,i){let r=Y(t,e,o);return F(r,i)}function re(t,e,o,i){let r=_(t,i);return fe(r,e,o)}var Ge=require("@latticexyz/utils");async function ne(t,e){let o=t.load;e(o),o.start();let[i,,r]=(0,Ge.deferred)();return o.on("complete",()=>{i()}),r}var je=require("@latticexyz/utils");function ie(t,e){let o={x:t.x,y:t.y},i={x:t.x+t.width,y:t.y+t.height},r=F(o,e),s=F(i,e),c=s.x-r.x+1,n=s.y-r.y+1,l=new je.CoordMap;for(let d=0;d<c;d++)for(let a=0;a<n;a++)l.set({x:r.x+d,y:r.y+a},!0);return l}function Le(t,e){let o=[];for(let i of t)for(let r of i.getChildren())r.active&&"x"in r&&"y"in r&&e.contains(r.x,r.y)&&(console.log("got one",r),o.push(r));return o.filter(i=>i!==void 0)}function se(t,e){return e.prefix&&e.suffix?t.generateFrameNames(e.assetKey,{start:e.startFrame,end:e.endFrame,prefix:e.prefix,suffix:e.suffix}):t.generateFrameNumbers(e.assetKey,{start:e.startFrame,end:e.endFrame})}var Qe=Phaser.Renderer.WebGL.Pipelines.SpriteFXPipeline||Object,D=class extends Qe{_tintColor=new Phaser.Display.Color;_outline=0;_outlineColor=new Phaser.Display.Color;constructor(e){super({game:e,renderTarget:!0,fragShader:`
        precision mediump float;
        uniform sampler2D uMainSampler;
        uniform vec2 uTextureSize;
        uniform vec3 tintColor;
        uniform int outline;
        uniform vec3 outlineColor;
        varying vec2 outTexCoord;
        
        vec3 rgb2hsv(vec3 c)
        {
            vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
            vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
            vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
            float d = q.x - min(q.w, q.y);
            float e = 1.0e-10;
            return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
        }
        
        void main(void)
        {
            vec4 srcColor;
            vec4 outColor;
            vec3 hsvColor;
            vec3 rgbColor;
            srcColor = texture2D(uMainSampler, outTexCoord);
            hsvColor = rgb2hsv(srcColor.rgb);
            if (hsvColor.g == 0.0 && !(tintColor.r == 0.0 && tintColor.g == 0.0 && tintColor.b == 0.0))
            {
              rgbColor = srcColor.rgb * tintColor;
            } else {
              rgbColor = srcColor.rgb;
            }
            outColor = vec4(rgbColor.r, rgbColor.g, rgbColor.b, srcColor.a);
            if(outline == 1) {
              vec2 distance = vec2(2.0, 2.0) / uTextureSize;
              float upAlpha = texture2D(uMainSampler, outTexCoord + vec2(0.0, distance.y)).a;
              float leftAlpha = texture2D(uMainSampler, outTexCoord + vec2(-distance.x, 0.0)).a;
              float downAlpha = texture2D(uMainSampler, outTexCoord + vec2(0.0, -distance.y)).a;
              float rightAlpha = texture2D(uMainSampler, outTexCoord + vec2(distance.x, 0.0)).a;
              if (srcColor.a == 0.0 && max(max(upAlpha, downAlpha), max(leftAlpha, rightAlpha)) == 1.0)
              {
                outColor = vec4(outlineColor, 1.0);
              }
            }
            gl_FragColor = outColor; 
        }
        `})}onDrawSprite(e){let o=e.pipelineData.hueTint,i=e.pipelineData.outline,r=e.pipelineData.outlineColor,s=o||0;if(typeof s=="number"&&(s=Phaser.Display.Color.IntegerToRGB(s)),i){this._outline=1;let c=r??0;typeof c=="number"&&(c=Phaser.Display.Color.IntegerToRGB(r)),this._outlineColor.setFromRGB(c)}else this._outline=0;this._tintColor.setFromRGB(s)}onDraw(e){this.set2f("uTextureSize",this.renderer.width,this.renderer.height),this.set3f("tintColor",this._tintColor.redGL,this._tintColor.greenGL,this._tintColor.blueGL),this.set1i("outline",this._outline),this.set3f("outlineColor",this._outlineColor.redGL,this._outlineColor.greenGL,this._outlineColor.blueGL),this.drawToGame(e)}};te(D,"KEY","HueTintFXPipeline");var E=class extends Phaser.Renderer.WebGL.Pipelines.MultiPipeline{constructor(e){super({game:e,fragShader:`
        #define SHADER_NAME PHASER_MULTI_V2_FS
        #define numTextures %count%
        precision highp float;
        uniform sampler2D uMainSampler[%count%];
        varying vec2 outTexCoord;
        varying float outTexId;
        varying float outTintEffect;
        varying vec4 outTint;
        
        vec4 getSampler (int index, vec2 uv)
        {
            for (int i = 0; i < numTextures; ++i)
            {
                if (i == index)
                {
                    return texture2D(uMainSampler[i], uv);
                }
            }
        
            //  Return black
            return vec4(0);
        }
        vec3 rgb2hsv(vec3 c)
        {
            vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
            vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
            vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
            float d = q.x - min(q.w, q.y);
            float e = 1.0e-10;
            return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
        }
        vec3 hsv2rgb(vec3 c)
        {
            vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
            vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
            return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
        }
        
        void main ()
        {
            vec4 srcColor;
            vec3 hsvColor;
            vec3 rgbColor;
            vec4 texel = vec4(outTint.bgr * outTint.a, outTint.a);
            srcColor = getSampler(int(outTexId), outTexCoord);
            vec4 color = srcColor * texel;
            //  Multiply texture tint
            vec3 hueTintColor = outTint.bgr;
            if (hueTintColor != vec3(0.0, 0.0, 0.0)) {
              hsvColor = rgb2hsv(srcColor.rgb);
              if (hsvColor.g == 0.0 && srcColor.a == 1.)
              {
                vec3 color = hsv2rgb(hsvColor);
                rgbColor = color * hueTintColor;
              } else {
                rgbColor = hsv2rgb(hsvColor);
              }
              color = vec4(rgbColor.r, rgbColor.g, rgbColor.b, srcColor.a);
            }
            gl_FragColor = color;
        }
        `})}};te(E,"KEY","MultiHueTintPipeline");function ye(t){let{preload:e,create:o,update:i,key:r}=t;return class extends Phaser.Scene{constructor(){super({key:r})}preload(){e&&e(this)}create(){o&&o(this);let c=this.renderer;c?.pipelines&&(c.pipelines.add(D.KEY,new D(this.game)),c.pipelines.add(E.KEY,new E(this.game)))}update(){i&&i(this)}}}function Ce(t){return{type:Phaser.WEBGL,scale:t.scale,pixelArt:!0,autoFocus:!0,render:{antialiasGL:!1,pixelArt:!0},scene:t.scenes}}var be=(i=>(i[i.Image=0]="Image",i[i.SpriteSheet=1]="SpriteSheet",i[i.MultiAtlas=2]="MultiAtlas",i))(be||{}),ae={Sprite:Phaser.GameObjects.Sprite,Rectangle:Phaser.GameObjects.Rectangle,Line:Phaser.GameObjects.Line,Text:Phaser.GameObjects.Text};var X=require("rxjs");var Z=require("@latticexyz/utils");function ce(t,e,o=100){let i={current:new Z.CoordMap},r=new X.Subject,s=new X.Subject;return t.pipe((0,X.map)(({x:n,y:l,width:d,height:a})=>ie({x:n-o,y:l-o,width:d+2*o,height:a+2*o},e))).subscribe(n=>{let l=(0,Z.subtract)(n,i.current);for(let a of l.coords())r.next(a);let d=(0,Z.subtract)(i.current,n);for(let a of d.coords())s.next(a);i.current=n}),{addedChunks$:r.asObservable(),removedChunks$:s.asObservable(),chunkSize:e,visibleChunks:i}}var Ee=require("@use-gesture/vanilla"),K=require("rxjs");function he(t,e){document.addEventListener("gesturestart",m=>m.preventDefault()),document.addEventListener("gesturechange",m=>m.preventDefault());let o=new K.BehaviorSubject(t.worldView),i=new K.BehaviorSubject(t.zoom),r=new K.Subject,s=new K.Subject,c=new Ee.Gesture(t.scene.game.canvas,{onPinch:m=>s.next(m),onWheel:m=>r.next(m)},{}),n=()=>{requestAnimationFrame(()=>o.next(t.worldView))};t.scene.scale.addListener("resize",n);function l(m){t.setZoom(m),o.next(t.worldView),i.next(m)}let d=s.pipe((0,K.throttleTime)(10),(0,K.map)(m=>{let g=i.getValue(),w=(m.offset[0]-g)*e.pinchSpeed;return g+w}),(0,K.map)(m=>Math.min(Math.max(m,e.minZoom),e.maxZoom)),(0,K.scan)((m,g)=>[m[1],g],[1,1])).subscribe(([,m])=>{c._ctrl.state.pinch&&(c._ctrl.state.pinch.offset[0]=m),l(m)}),a=r.pipe((0,K.filter)(m=>!m.pinching),(0,K.sampleTime)(10),(0,K.map)(m=>m.delta.map(g=>g*e.wheelSpeed)),(0,K.map)(m=>m.map(g=>g/t.zoom)),(0,K.map)(m=>[t.scrollX+m[0],t.scrollY+m[1]])).subscribe(([m,g])=>{t.setScroll(m,g),o.next(t.worldView)});function k(m,g){m.ignoreCamera(t.id,g)}function S(m,g,u){let w=Y(m,g,u);C(w.x,w.y)}function C(m,g){t.centerOn(m,g),requestAnimationFrame(()=>o.next(t.worldView))}function x(m,g){t.setScroll(m,g),requestAnimationFrame(()=>o.next(t.worldView))}return{phaserCamera:t,worldView$:o,zoom$:i,ignore:k,dispose:()=>{d.unsubscribe(),a.unsubscribe(),c.destroy(),t.scene.scale.removeListener("resize",n)},centerOnCoord:S,centerOn:C,setScroll:x,setZoom:l}}var q=require("mobx"),z=require("rxjs"),Me=require("@latticexyz/utils");var Re=require("@latticexyz/utils");function et(){let t=new Re.CoordMap,e=new Map;function o(s){let c=t.get(s);return c||(c=new Set,t.set(s,c)),c}function i(s,c){let n=e.get(s);(n&&o(n))?.delete(s),o(c).add(s),e.set(s,c)}function r(s){let c=e.get(s);(c&&o(c))?.delete(s),e.delete(s)}return{set:i,remove:r,get:o}}function xe(t,e,o){let i=et(),r=new Map,s=(0,z.pipe)((0,z.map)(a=>(0,z.from)(i.get(a))),(0,z.mergeMap)(a=>a),(0,z.map)(a=>t.get(a,"Existing")),(0,Me.filterNullish)()),c=o.addedChunks$.pipe(s).subscribe(a=>a.spawn()),n=o.removedChunks$.pipe(s).subscribe(a=>a.despawn());function l(a){r.get(a.id)&&console.error("Entity is being tracked multiple times",a);let k=(0,q.computed)(()=>F(a.position,o.chunkSize),{equals:oe}),S=(0,q.reaction)(()=>k.get(),C=>{i.set(a.id,C),o.visibleChunks.current.get(C)?a.spawn():a.despawn()},{fireImmediately:!0});r.set(a.id,S)}let d=(0,q.observe)(t.objects,a=>{if(a.type==="add"&&l(a.newValue),a.type==="delete"){i.remove(a.oldValue.id);let k=r.get(a.oldValue.id);k&&k(),r.delete(a.oldValue.id)}});return{dispose:()=>{for(let a of r.values())a();d(),c.unsubscribe(),n.unsubscribe()}}}var U=require("mobx");function tt(t){return t}function ot(t){return t}function rt(t){return t}function nt(t){return t}function it(t){return t}function le(t,e){return e==="Sprite"}function ge(t,e){return e==="Rectangle"}function Fe(t,e,o,i=0){let r=(0,U.observable)({x:0,y:0}),s=new Map,c=new Map,n,l={current:i};function d(u){return ze(u)?w=>{u(w),(0,U.runInAction)(()=>{r.x=w.x,r.y=w.y})}:u}async function a({id:u,now:w,once:b,update:h}){let P=b&&ze(b);P&&(0,U.runInAction)(()=>{r.x=P.x??r.x,r.y=P.y??r.y}),b&&s.set(u,d(b)),h&&c.set(u,d(h)),n&&w&&await d(w)(n),n&&b&&b(n)}function k(u){return s.has(u)||c.has(u)}function S(u,w){s.delete(u),c.delete(u),n&&(C(n,w),Ie(n,s.values()))}function C(u,w=!0){w&&(le(u,o)&&u.stop(),B(u)),u.setDepth(10),u.cameraFilter=l.current,u.resetPipeline(!0,!0),u.setScale(1,1),u.setOrigin(0,0),u.setAlpha(1),u.setScrollFactor(1),u.clearMask(),u.setData("objectPoolId",null),le(u,o)&&(u.clearTint(),u.setTexture("")),ge(u,o)&&(u.width=0,u.height=0)}function x(u){l.current=u,n&&(n.cameraFilter=u)}function m(){if(n)return;let u=e.get();C(u),Ie(u,s.values()),u.setActive(!0),u.setVisible(!0),u.setData("objectPoolId",t),n=u}function g(){n&&e.killAndHide(n),n=void 0}return{setComponent:a,hasComponent:k,removeComponent:S,spawn:m,despawn:g,position:r,id:t,setCameraFilter:x,type:o}}function Ie(t,e){if(t)for(let o of e)o(t)}function ze(t){let e,o=new Proxy({x:void 0,y:void 0},{get:(i,r)=>r==="setPosition"?(s,c)=>e={x:s,y:c}:r==="setX"?s=>e={x:s}:r==="setY"?s=>e={y:s}:()=>{},set:(i,r,s)=>(r==="x"&&(e=e?{...e,x:s}:{x:s}),r==="y"&&(e=e?{...e,y:s}:{y:s}),!0)});return t(o),e}var De=require("mobx"),We=require("@latticexyz/utils");function st(t){return Object.keys(ae).includes(t)}function Te(t){let e=(0,We.mapObject)(ae,n=>t.add.group({classType:n})),o=(0,De.observable)(new Map),i={current:0};function r(n,l){typeof n=="number"&&(n=String(n));let d=o.get(n);return st(l)?(d||(d=Fe(n,e[l],l,i.current)),o.has(n)||o.set(n,d),d):d||void 0}function s(n){typeof n=="number"&&(n=String(n));let l=o.get(n);l&&l.despawn(),o.delete(n)}function c(n,l){l?i.current|=n:i.current&=~n;for(let d of o.values())d.setCameraFilter(i.current)}return{get:r,remove:s,objects:o,groups:e,ignoreCamera:c}}var _e=require("@latticexyz/utils");var $e=require("@latticexyz/utils");function ue(t){let{scene:e,tilesets:o,layerConfig:i,chunks:r,backgroundTile:s,tiles:c,tileWidth:n,tileHeight:l}=t,d=Object.keys(i.layers).map(f=>i.layers[f].tilesets).flat();if(I(r.chunkSize,n)!==0||I(r.chunkSize,l)!==0)throw new Error("Chunks pixel size must be a multiple of tile width and height to be used with chunked tilemap");let a=new _e.CoordMap,k={x:r.chunkSize/n,y:r.chunkSize/l},S=new Set,C={current:!0};for(let f of r.visibleChunks.current.coords())p(f);let x=r.addedChunks$.subscribe(f=>{p(f)}),m=r.removedChunks$.subscribe(f=>{h(f)});S.add(()=>x?.unsubscribe()),S.add(()=>m?.unsubscribe);function g(f,v,A,j,G,L){let M={};for(let R of Object.keys(i.layers)){let J=i.layers[R],H=f.createBlankLayer(R,J.tilesets.map(pe=>o[pe]),A,j,G,L);if(!H){console.error(`Adding tilemap layer ${R} failed.`);continue}M[R]=H;let Q=v.game.renderer;J.hasHueTintShader&&Q?.pipelines&&(M[R].pipeline=Q.pipelines.get(E.KEY))}return{layers:Object.values(M),defaultLayer:M[i.defaultLayer]}}function u(f){let v=new Phaser.Tilemaps.MapData({tileHeight:l,tileWidth:n,width:k.x,height:k.y,tilesets:Object.entries(o).filter(([L])=>d.includes(L)).map(([,L])=>L)}),A=new Phaser.Tilemaps.Tilemap(e,v),j=_(f,r.chunkSize),{defaultLayer:G}=g(A,e,j.x,j.y,k.x,k.y);return A.setLayer(G),a.set(f,A),A}function w(f){return a.get(f)||u(f)}function b(f){let v=V(f,n,l,r.chunkSize);return w(v)}function h(f,v){if(!C.current&&!v||!a.has(f))return;w(f).destroy(),a.delete(f)}function P(f,v,A,j){if(!C.current)return;let G=b(f),L=G.putTileAt(v,I(f.x,k.x),I(f.y,k.y),void 0,A);if(L==null)throw new Error("putTileAt failed");L.width=G.tileWidth,L.height=G.tileHeight,j&&(L.tint=j)}function p(f){if(!C.current)return;let v=w(f),A=re(f,n,l,r.chunkSize);for(let j of Object.keys(i.layers))v.forEachTile(G=>{let L={x:A.x+G.x,y:A.y+G.y},M=j===i.defaultLayer?(0,$e.pickRandom)(s):-1,R=c[j].get(L)||M;G.index=R},void 0,void 0,void 0,void 0,void 0,void 0,j)}function T(){for(let f of a.values())f.destroy();a.clear();for(let f of S)f()}function O(){return a.size}function N(f){if(f!==C.current){C.current=f;for(let v of r.visibleChunks.current.coords())C.current?p(v):h(v,!0)}}return{size:O,putTileAt:P,dispose:T,setVisible:N,visible:C,tileWidth:n,tileHeight:l}}var Ve=require("@latticexyz/utils");function me(t){let{chunks:e,layerConfig:{layers:o,defaultLayer:i},tileWidth:r,tileHeight:s}=t,c={};for(let d of Object.keys(o))c[d]=new Ve.CoordMap;let n=ue({...t,tiles:c});function l(d,a,k,S){c[k||i].set(d,a);let C=V(d,r,s,e.chunkSize);n.visible&&e.visibleChunks.current.get(C)&&n.putTileAt(d,a,k,S)}return{...n,putTileAt:l,tiles:c}}var ve=require("@latticexyz/utils");function de(t){let{layerConfig:{layers:e,defaultLayer:o},animationInterval:i,scene:r}=t,s=o,c=0,n={},l={};for(let b of Object.keys(e))l[b]=new ve.CoordMap;let d={};for(let b of Object.keys(e))d[b]=new ve.CoordMap;let a=me(t);function k(b,h){n[b]={frames:h,index:0}}function S(b,h,P=s){l[P].set(b,h)}function C(b,h=s){let P=l[h].get(b),p=P&&n[P];l[h].delete(b),p&&a.putTileAt(b,p.frames[0],h)}function x(b,h=s){let P=l[h].get(b);P&&(d[h].set(b,P),C(b,h))}function m(b,h=s){let P=d[h].get(b);P&&(d[h].delete(b),S(b,P,h))}function g(){for(let b of Object.keys(n)){let h=n[b];h&&(h.index=I(h.index+1,h.frames.length))}for(let b of Object.keys(l)){let h=l[b];for(let P of h.coords()){let p=h.get(P),T=p&&n[p];if(!T)continue;let O=T.frames[T.index];a.putTileAt(P,O,b)}}}function u(b){b<c+i||(c=b,g())}function w(){r.events.removeListener("update",u),a.dispose()}return r.events.addListener("update",u),{...a,putAnimationAt:S,removeAnimationAt:C,pauseAnimationAt:x,resumeAnimationAt:m,registerAnimation:k,dispose:w}}var y=require("rxjs"),$=require("mobx"),W=require("@latticexyz/utils");function ke(t){let e=new Set,o={current:!0};t.mouse?.disableContextMenu();function i(){o.current=!1}function r(){o.current=!0}function s(p){t.setDefaultCursor(p)}let c=new y.Subject,n=(0,y.fromEvent)(document,"mousemove").pipe((0,y.filter)(()=>o.current),(0,y.map)(()=>({pointer:t.manager?.activePointer})),(0,W.filterNullish)()),l=(0,y.fromEvent)(document,"mousedown").pipe((0,y.filter)(()=>o.current),(0,y.map)(p=>({pointer:t.manager?.activePointer,event:p})),(0,W.filterNullish)()),d=(0,y.fromEvent)(document,"mouseup").pipe((0,y.filter)(()=>o.current),(0,y.map)(p=>({pointer:t.manager?.activePointer,event:p})),(0,W.filterNullish)()),a=(0,y.merge)(l,d).pipe((0,y.filter)(()=>o.current),(0,y.map)(({event:p})=>[p.type==="mousedown"&&p.button===0,Date.now()]),(0,y.bufferCount)(2,1),(0,y.filter)(([p,T])=>p[0]&&!T[0]&&T[1]-p[1]<250),(0,y.map)(()=>t.manager?.activePointer),(0,W.filterNullish)()),k=l.pipe((0,y.filter)(()=>o.current),(0,y.map)(()=>Date.now()),(0,y.bufferCount)(2,1),(0,y.filter)(([p,T])=>T-p<500),(0,y.throttleTime)(500),(0,y.map)(()=>t.manager?.activePointer),(0,W.filterNullish)()),S=(0,y.merge)(l,d).pipe((0,y.filter)(({pointer:p})=>o.current&&p.rightButtonDown()),(0,y.map)(()=>t.manager?.activePointer),(0,W.filterNullish)()),C=(0,y.merge)(l.pipe((0,y.map)(()=>{})),(0,y.merge)(d,n).pipe((0,y.pairwise)(),(0,y.scan)((p,[{pointer:T},{pointer:O}])=>O.leftButtonDown()?T.leftButtonDown()&&p?{...p,width:O.worldX-p.x,height:O.worldY-p.y}:{x:O.worldX,y:O.worldY,width:0,height:0}:void 0,void 0),(0,W.filterNullish)(),(0,y.filter)(p=>Math.abs(p.width)>10&&Math.abs(p.height)>10))).pipe((0,y.filter)(()=>o.current),(0,y.distinctUntilChanged)()),x=(0,$.observable)(new Set),m=t.keyboard,g=new Map;for(let p of Object.keys(Phaser.Input.Keyboard.KeyCodes))b(p);let u=c.pipe((0,y.filter)(()=>o.current)).subscribe(p=>{let T=g.get(p.keyCode);T&&(0,$.runInAction)(()=>{p.isDown&&x.add(T),p.isUp&&x.delete(T)})});e.add(()=>u?.unsubscribe());let w=(0,y.merge)(l,d).subscribe(({pointer:p})=>{(0,$.runInAction)(()=>{p.leftButtonDown()?x.add("POINTER_LEFT"):x.delete("POINTER_LEFT"),p.rightButtonDown()?x.add("POINTER_RIGHT"):x.delete("POINTER_RIGHT")})});e.add(()=>w?.unsubscribe());function b(p){if(!m){console.warn(`Adding key ${p} failed. No phaser keyboard detected.`);return}let T=m.addKey(p,!1);g.set(T.keyCode,p),T.removeAllListeners(),T.emitOnRepeat=!0,T.on("down",O=>c.next(O)),T.on("up",O=>c.next(O))}function h(p,T){let O=(0,$.reaction)(()=>p(x),N=>{N&&T()},{fireImmediately:!0});e.add(O)}function P(){for(let p of e)p()}return{keyboard$:c.asObservable(),pointermove$:n,pointerdown$:l,pointerup$:d,click$:a,doubleClick$:k,rightClick$:S,drag$:C,pressedKeys:x,dispose:P,disableInput:i,enableInput:r,setCursor:s,enabled:o,onKeyPress:h}}var qe=require("@latticexyz/utils");async function at(t){let{scale:e,sceneConfig:o,cameraConfig:i,cullingChunkSize:r}=t,s=Object.keys(o).map(C=>{let{preload:x,create:m,update:g}=o[C];return ye({key:C,preload:x,create:m,update:g})}),c=Ce({scenes:s,scale:e}),n=new Phaser.Game(c),[l,,d]=(0,qe.deferred)();n.events.on("ready",l),c.type===Phaser.HEADLESS&&n.textures.emit("ready"),await d;function a(){let C=window.innerWidth/n.scale.zoom,x=window.innerHeight/n.scale.zoom;n.scale.resize(C,x)}a(),window.addEventListener("resize",a);let k={};for(let C of n.scene.getScenes(!1)){let x=C.scene.key,m=o[x];for(let[f,v]of Object.entries(o[x].assets))await ne(C,A=>{v.type===0?A.image(f,v.path):v.type===1?A.spritesheet(f,v.path,v.options):v.type===2&&A.multiatlas(f,v.path,v.options.imagePath)});let g=Te(C),u=he(C.cameras.main,i),w=ce(u.worldView$,r),b=xe(g,u,w);for(let f of m.animations)C.anims.create({key:f.key,frames:se(C.anims,f),frameRate:f.frameRate,repeat:f.repeat});let h=new Phaser.Tilemaps.Tilemap(C,new Phaser.Tilemaps.MapData),P={};for(let[f,{assetKey:v,tileWidth:A,tileHeight:j}]of Object.entries(o[x].tilesets)){let G=h.addTilesetImage(f,v,A,j);if(!G){console.error(`Adding tileset ${f} failed.`);continue}P[f]=G}let p=P,T={};for(let f of Object.keys(m.maps)){let{layers:v,backgroundTile:A,tileWidth:j,tileHeight:G,animationInterval:L,tileAnimations:M,chunkSize:R}=m.maps[f],J=ce(u.worldView$,R),H=de({scene:C,tilesets:p,layerConfig:v,chunks:J,tileWidth:j,tileHeight:G,backgroundTile:A,animationInterval:L});if(M)for(let[Q,pe]of Object.entries(M))H.registerAnimation(Q,pe);T[f]=H}let O=T,N=ke(C.input);k[x]={phaserScene:C,objectPool:g,camera:u,culling:b,maps:O,input:N,config:o[x]}}let S=k;return{game:n,scenes:S,dispose:()=>{n.destroy(!0);for(let C of Object.keys(S)){let x=S[C];x.camera.dispose(),x.culling.dispose(),x.input.dispose();for(let m of Object.values(x.maps))m.dispose()}window.removeEventListener("resize",a)}}}var Ne=require("@latticexyz/utils");function ct(){let t=Math.random()*255,e=Math.random()*255,o=Math.random()*255;return t*65535+e*255+o}function lt(t,e,o,i,r){let s={logViewport:!1,visualizeChunks:!0,visualizeViewport:!1,logNumVisibleChunks:!1,logObjectStats:!1,logMaps:!0},c=new Ne.CoordMap,n=o.add.rectangle(0,0,1,1,16711680,.2);n.setInteractive(),n.on("pointerup",()=>{console.log("clicked",n)}),t.worldView$.subscribe(l=>{s.logViewport&&console.log(l),s.visualizeViewport&&(n.setScale(l.width,l.height),n.setPosition(l.centerX,l.centerY)),s.logObjectStats&&console.log(`Entities: ${i.objects.size} / Pool size: ${Object.values(i.groups).reduce((d,a)=>d+a.getChildren().length,0)} / Pool active: ${Object.values(i.groups).reduce((d,a)=>d+a.countActive(),0)}`),s.logMaps&&console.log("Num maps",r.size())}),e.addedChunks$.subscribe(l=>{if(s.visualizeChunks){let d=_(l,e.chunkSize),a=o.add.rectangle(d.x+e.chunkSize/2,d.y+e.chunkSize/2,e.chunkSize,e.chunkSize,ct(),.5);a.setInteractive(),a.on("pointerup",()=>{console.log("clicked",a)}),c.set(l,a)}s.logNumVisibleChunks&&console.log("Number of visible chunks: ",c.size)}),e.removedChunks$.subscribe(l=>{s.visualizeChunks&&(c.get(l)?.destroy(),c.delete(l)),s.logNumVisibleChunks&&console.log("Number of visible chunks: ",c.size)})}0&&(module.exports={AssetType,GameObjectClasses,HueTintAndOutlineFXPipeline,MultiHueTintPipeline,ZERO_VECTOR,addCoords,chunkCoordToTileCoord,chunkToPixelCoord,coordEq,cornerTileCoordsFromRegionCoords,createAnimatedTilemap,createCamera,createChunkedTilemap,createChunks,createCulling,createDebugger,createInput,createObjectPool,createPhaserEngine,createVirtualTilemap,defineAssetsConfig,defineCameraConfig,defineMapConfig,definePhaserConfig,defineScaleConfig,defineScene,defineSceneConfig,generateFrames,getChunksInArea,getObjectsInArea,isRectangle,isSprite,isTileInArea,load,mod,pixelCoordToTileCoord,pixelToChunkCoord,removeAllTweens,tileCoordToChunkCoord,tileCoordToPixelCoord,tween});
//# sourceMappingURL=index.js.map